AWSTemplateFormatVersion: "2010-09-09"
Description: "Backroom Blackjack S3 Resources"

Parameters:
  Stage:
    Type: String
    Description: Deployment stage (e.g., dev, prod)
    AllowedPattern: ^[a-zA-Z0-9-]+$
  AppName:
    Type: String
    Description: Application short name used in resource naming (e.g., cct)

Resources:
  # S3 Bucket for frontend static files (served via CloudFront)
  FrontendBucket:
    Type: AWS::S3::Bucket
    DeletionPolicy: Delete
    UpdateReplacePolicy: Delete
    Properties:
      BucketName: !Sub "${AppName}-frontend-${Stage}"
      PublicAccessBlockConfiguration:
        BlockPublicAcls: false
        BlockPublicPolicy: false
        IgnorePublicAcls: false
        RestrictPublicBuckets: false

  # S3 Bucket for user-uploaded files
  CCTBucket:
    Type: AWS::S3::Bucket
    DeletionPolicy: Delete
    UpdateReplacePolicy: Delete
    Properties:
      BucketName: !Sub "${AppName}-userfiles-${Stage}"

  # S3 Bucket for user avatar images (public read access)
  AvatarBucket:
    Type: AWS::S3::Bucket
    DeletionPolicy: Delete
    UpdateReplacePolicy: Delete
    Properties:
      BucketName: !Sub "${AppName}-avatars-${Stage}"
      PublicAccessBlockConfiguration:
        BlockPublicAcls: false
        BlockPublicPolicy: false
        IgnorePublicAcls: false
        RestrictPublicBuckets: false
      CorsConfiguration:
        CorsRules:
          - AllowedHeaders:
              - "*"
            AllowedMethods:
              - PUT
              - GET
              - HEAD
            AllowedOrigins:
              - "*"
            MaxAge: 3000

  # Bucket policy to allow public read access to avatars
  AvatarBucketPolicy:
    Type: AWS::S3::BucketPolicy
    Properties:
      Bucket: !Ref AvatarBucket
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Sid: PublicReadGetObject
            Effect: Allow
            Principal: "*"
            Action: s3:GetObject
            Resource: !Sub "${AvatarBucket.Arn}/*"

Outputs:
  FrontendBucketName:
    Description: Name of the frontend bucket
    Value: !Ref FrontendBucket

  FrontendBucketArn:
    Description: ARN of the frontend S3 bucket
    Value: !GetAtt FrontendBucket.Arn

  FrontendBucketRegionalDomainName:
    Description: Regional domain name of the frontend S3 bucket
    Value: !GetAtt FrontendBucket.RegionalDomainName

  CCTBucketName:
    Description: Name of the user files bucket
    Value: !Ref CCTBucket
    # Export removed: top-level template will declare global export

  CCTBucketArn:
    Description: ARN of the user files S3 bucket
    Value: !GetAtt CCTBucket.Arn
    # Export removed: top-level template will declare global export

  CCTBucketRegionalDomainName:
    Description: Regional domain name of the user files S3 bucket
    Value: !GetAtt CCTBucket.RegionalDomainName

  AvatarBucketName:
    Description: Name of the avatar bucket
    Value: !Ref AvatarBucket

  AvatarBucketArn:
    Description: ARN of the avatar S3 bucket
    Value: !GetAtt AvatarBucket.Arn

  AvatarBucketRegionalDomainName:
    Description: Regional domain name of the avatar S3 bucket
    Value: !GetAtt AvatarBucket.RegionalDomainName
